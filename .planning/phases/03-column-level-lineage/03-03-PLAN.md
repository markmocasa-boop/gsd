---
phase: 03-column-level-lineage
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - frontend/src/hooks/use-lineage.ts
  - frontend/src/lib/lineage-types.ts
  - frontend/src/components/features/lineage/LineageGraph.tsx
  - frontend/src/components/features/lineage/TableNode.tsx
  - frontend/src/components/features/lineage/ColumnEdge.tsx
  - frontend/src/components/features/lineage/ImpactPanel.tsx
  - frontend/src/components/features/lineage/RootCausePanel.tsx
  - frontend/src/app/lineage/page.tsx
  - frontend/src/app/lineage/[nodeId]/page.tsx
  - frontend/package.json
autonomous: true

must_haves:
  truths:
    - "User can view column-to-column data flow paths in interactive graph"
    - "User can see transformation logic (CONCAT, SUM, JOIN, etc.) on edges"
    - "User can select a column and see downstream impact analysis"
    - "User can trace a quality issue back to root cause through upstream lineage"
    - "Graph layout automatically adjusts using elkjs"
  artifacts:
    - path: "frontend/src/components/features/lineage/LineageGraph.tsx"
      provides: "React Flow wrapper with elkjs layout"
      exports: ["LineageGraph"]
    - path: "frontend/src/components/features/lineage/TableNode.tsx"
      provides: "Custom node with expandable columns"
      exports: ["TableNode"]
    - path: "frontend/src/components/features/lineage/ImpactPanel.tsx"
      provides: "Downstream impact analysis sidebar"
      exports: ["ImpactPanel"]
    - path: "frontend/src/components/features/lineage/RootCausePanel.tsx"
      provides: "Upstream root cause tracing sidebar"
      exports: ["RootCausePanel"]
    - path: "frontend/src/hooks/use-lineage.ts"
      provides: "TanStack Query hooks for lineage API"
      exports: ["useLineageGraph", "useDownstreamImpact", "useUpstreamSources"]
  key_links:
    - from: "frontend/src/components/features/lineage/LineageGraph.tsx"
      to: "@xyflow/react"
      via: "ReactFlow component"
      pattern: "ReactFlow.*nodes.*edges"
    - from: "frontend/src/components/features/lineage/LineageGraph.tsx"
      to: "elkjs"
      via: "automatic graph layout"
      pattern: "elk\\.layout"
    - from: "frontend/src/hooks/use-lineage.ts"
      to: "Supabase"
      via: "lineage_nodes and lineage_edges queries"
      pattern: "supabase.*from.*lineage"
---

<objective>
Build the lineage visualization frontend with React Flow graph, custom table/column nodes, impact analysis panel, and root cause tracing.

Purpose: Enable users to visually explore column-level data lineage, understand how data transforms, analyze downstream impact of changes, and trace quality issues back to root causes. This is the user-facing value of lineage tracking.

Output: Interactive lineage graph page with table nodes, column edges, impact analysis, and root cause panels.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-column-level-lineage/03-RESEARCH.md
@.planning/phases/03-column-level-lineage/03-01-SUMMARY.md
@frontend/src/hooks/use-rules.ts
@frontend/src/components/features/rules/rule-list.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Lineage Types and Hooks</name>
  <files>
    frontend/src/lib/lineage-types.ts
    frontend/src/hooks/use-lineage.ts
    frontend/package.json
  </files>
  <action>
    Install dependencies and create lineage data layer:

    **package.json updates:**
    Add dependencies (use exact versions from research):
    ```json
    {
      "@xyflow/react": "^12.0.0",
      "elkjs": "^0.11.0"
    }
    ```
    Run: `cd frontend && npm install @xyflow/react@^12 elkjs@^0.11`

    **lib/lineage-types.ts:**

    TypeScript interfaces for lineage data:

    ```typescript
    // Node types matching database
    export type NodeType = 'dataset' | 'column' | 'job';
    export type EdgeType = 'derives_from' | 'transforms_to';
    export type TransformationType = 'DIRECT' | 'INDIRECT';
    export type TransformationSubtype =
      | 'IDENTITY' | 'TRANSFORMATION' | 'AGGREGATION'
      | 'JOIN' | 'GROUP_BY' | 'FILTER' | 'SORT' | 'WINDOW' | 'CONDITIONAL';

    export interface LineageNode {
      id: string;
      node_type: NodeType;
      namespace: string;
      name: string;
      parent_id: string | null;
      data_type: string | null;
      metadata: Record<string, unknown> | null;
      created_at: string;
    }

    export interface LineageEdge {
      id: string;
      source_id: string;
      target_id: string;
      edge_type: EdgeType;
      transformation_type: TransformationType | null;
      transformation_subtype: TransformationSubtype | null;
      transformation_description: string | null;
      job_id: string | null;
      created_at: string;
    }

    // For graph rendering
    export interface TableNodeData {
      label: string;
      namespace: string;
      columns: ColumnData[];
      isHighlighted?: boolean;
    }

    export interface ColumnData {
      id: string;
      name: string;
      type: string | null;
      isHighlighted?: boolean;
      hasUpstream?: boolean;
      hasDownstream?: boolean;
    }

    export interface ImpactNode {
      id: string;
      node_type: NodeType;
      namespace: string;
      name: string;
      depth: number;
      transformation?: string;
    }
    ```

    **hooks/use-lineage.ts:**

    TanStack Query hooks (follow use-rules.ts pattern):

    `useLineageGraph(namespace?: string)`:
    - Fetch all lineage_nodes and lineage_edges
    - Optionally filter by namespace prefix
    - Transform to React Flow nodes/edges format
    - Include column nodes grouped under parent dataset nodes

    `useLineageNode(nodeId: string)`:
    - Fetch single node with its edges
    - Include parent dataset if node is a column
    - Include child columns if node is a dataset

    `useDownstreamImpact(columnId: string, options?: { maxDepth?: number })`:
    - Call Supabase RPC: get_downstream_nodes
    - Return ImpactNode[] with depth information
    - Enabled only when columnId is provided

    `useUpstreamSources(columnId: string, options?: { maxDepth?: number })`:
    - Call Supabase RPC: get_upstream_nodes
    - Return ImpactNode[] for root cause tracing
    - Enabled only when columnId is provided

    `useSearchLineageNodes(query: string)`:
    - Search nodes by name (ilike pattern)
    - Return matching nodes for search/autocomplete
    - Debounced query (300ms)

    `useLineageRuns()`:
    - List recent lineage extraction runs
    - Include status, counts, timing
    - For showing extraction history

    `useTriggerExtraction()`:
    - Mutation to POST /api/lineage/extract
    - Trigger manual lineage extraction
    - Invalidate lineage queries on success
  </action>
  <verify>
    cd frontend && npm install @xyflow/react@^12 elkjs@^0.11 --save

    # Check types compile
    npx tsc --noEmit src/lib/lineage-types.ts 2>&1 || echo "Check for type errors"

    # Check hooks syntax
    npx tsc --noEmit src/hooks/use-lineage.ts 2>&1 || echo "Check for hook errors"
  </verify>
  <done>
    React Flow and elkjs installed. Lineage types defined. TanStack Query hooks provide graph data, impact analysis, and root cause queries.
  </done>
</task>

<task type="auto">
  <name>Task 2: Lineage Graph Components</name>
  <files>
    frontend/src/components/features/lineage/LineageGraph.tsx
    frontend/src/components/features/lineage/TableNode.tsx
    frontend/src/components/features/lineage/ColumnEdge.tsx
    frontend/src/components/features/lineage/ImpactPanel.tsx
    frontend/src/components/features/lineage/RootCausePanel.tsx
  </files>
  <action>
    Create React Flow-based lineage visualization components:

    **LineageGraph.tsx:**

    Main graph container using React Flow:
    - Import ReactFlow, Background, Controls, MiniMap from @xyflow/react
    - Import ELK from elkjs/lib/elk.bundled.js
    - State: nodes, edges, selectedNode, showImpact, showRootCause
    - Props: initialNodes, initialEdges, onNodeSelect

    elkjs layout configuration (from research):
    ```typescript
    const elkOptions = {
      'elk.algorithm': 'layered',
      'elk.direction': 'RIGHT',
      'elk.layered.spacing.nodeNodeBetweenLayers': '100',
      'elk.spacing.nodeNode': '80',
      'elk.layered.nodePlacement.strategy': 'SIMPLE'
    };
    ```

    getLayoutedElements function:
    - Convert nodes/edges to ELK graph format
    - Call elk.layout(graph)
    - Map positions back to React Flow nodes
    - Trigger layout on initial load and data changes

    Features:
    - Click node to select and show details
    - Right-click column for context menu (impact/root cause)
    - Highlight path when column selected
    - Fit view on load with padding

    Register custom node types: { table: TableNode }
    Register custom edge types: { column: ColumnEdge }

    **TableNode.tsx:**

    Custom node for dataset with expandable columns (from research pattern):
    - Props: NodeProps<TableNodeData>
    - State: expanded (default true)
    - Header: table name, namespace (truncated), expand/collapse toggle
    - Column list with:
      - Handle on left (target) and right (source) for each column
      - Column name and type
      - Highlight state for selected column
      - Visual indicator for upstream/downstream connections
    - Styling: white bg, rounded, shadow, blue border when selected
    - Click column to select, double-click to toggle highlight

    Handles positioned per-column:
    - Use `style={{ top: offset }}` for vertical positioning
    - Handle IDs: `{columnName}-source`, `{columnName}-target`

    **ColumnEdge.tsx:**

    Custom edge for column-to-column connections:
    - Props: EdgeProps + transformation label
    - Animated path using getBezierPath
    - Label showing transformation type (e.g., "CONCAT", "SUM", "JOIN")
    - Color coding by transformation type:
      - IDENTITY: gray
      - TRANSFORMATION: blue
      - AGGREGATION: purple
      - JOIN: orange
      - FILTER/GROUP_BY/WINDOW: green
    - Hover to show full transformation description
    - Thicker stroke when part of highlighted path

    **ImpactPanel.tsx:**

    Sidebar for downstream impact analysis:
    - Props: columnId, onClose
    - Use useDownstreamImpact hook
    - Header: "Downstream Impact: {columnName}"
    - Group affected nodes by depth level
    - Each node shows:
      - Icon by node_type (table/column)
      - Full path (namespace.table.column)
      - Transformation that led here
    - Depth indicator (badges: Direct, 2 hops, 3 hops, etc.)
    - Count summary at top
    - Click node to navigate to it in graph
    - Loading and empty states

    **RootCausePanel.tsx:**

    Sidebar for upstream root cause tracing:
    - Props: columnId, qualityIssue (optional), onClose
    - Use useUpstreamSources hook
    - Header: "Root Cause Analysis: {columnName}"
    - If qualityIssue provided, show issue context
    - List source nodes grouped by depth (reverse order - sources first)
    - Highlight likely root causes (furthest upstream)
    - Each node shows:
      - Source path
      - Transformation description
      - Quality score if available (link to quality data)
    - Click to navigate to source in graph
    - Loading and empty states
  </action>
  <verify>
    # Check components compile
    cd frontend && npx tsc --noEmit src/components/features/lineage/*.tsx 2>&1 || echo "Check for errors"

    # Verify React Flow integration
    grep -l "ReactFlow\|useNodesState" src/components/features/lineage/*.tsx
  </verify>
  <done>
    LineageGraph renders React Flow with elkjs layout. TableNode displays datasets with expandable columns. ColumnEdge shows transformation labels. ImpactPanel and RootCausePanel provide analysis sidebars.
  </done>
</task>

<task type="auto">
  <name>Task 3: Lineage Pages</name>
  <files>
    frontend/src/app/lineage/page.tsx
    frontend/src/app/lineage/[nodeId]/page.tsx
  </files>
  <action>
    Create lineage pages following existing app router patterns:

    **app/lineage/page.tsx:**

    Main lineage explorer page:
    - "use client" directive
    - Layout: Full-height graph with optional sidebars
    - Components:
      - Search bar at top (useSearchLineageNodes)
      - Namespace filter dropdown
      - LineageGraph as main content (flex-1)
      - ImpactPanel (conditional, slide from right)
      - RootCausePanel (conditional, slide from right)
    - State:
      - selectedNodeId
      - showImpactFor (columnId or null)
      - showRootCauseFor (columnId or null)
      - namespaceFilter
    - Use useLineageGraph to fetch data
    - Transform LineageNode[] to React Flow format
    - Group columns under parent dataset nodes

    Graph interaction:
    - Click column: select and show in side panel
    - Right-click column: context menu with "Impact Analysis" and "Root Cause"
    - Keyboard: Escape to close panels
    - URL state: ?selected={nodeId} for deep linking

    Top bar:
    - Search input with autocomplete
    - "Last extracted: {time}" badge
    - "Trigger Extraction" button (calls useTriggerExtraction)

    **app/lineage/[nodeId]/page.tsx:**

    Node detail page (for deep links):
    - Fetch node with useLineageNode
    - If dataset: show columns, direct connections, profile link
    - If column: show upstream/downstream summary, quality rules link
    - Navigation: Back to full graph, view in graph (scroll to node)
    - Metadata display from node.metadata JSONB
    - Links:
      - "View Data Quality Rules" -> /rules?column={name}
      - "View Profile" -> /profiles/{datasetId}
      - "Impact Analysis" -> opens panel on graph page

    Loading states:
    - Skeleton for graph loading
    - "No lineage data" empty state with extraction button
    - Error boundary for graph rendering errors
  </action>
  <verify>
    # Check pages compile
    cd frontend && npx tsc --noEmit src/app/lineage/page.tsx src/app/lineage/\\[nodeId\\]/page.tsx 2>&1 || echo "Check for errors"

    # Build check
    cd frontend && npm run build 2>&1 | head -20
  </verify>
  <done>
    Lineage explorer page renders interactive graph with search, filtering, and analysis panels. Node detail page provides deep links and metadata view. Frontend integrates with lineage database through hooks.
  </done>
</task>

</tasks>

<verification>
1. `cd frontend && npm run build` succeeds without errors
2. LineageGraph renders with elkjs automatic layout
3. TableNode expands/collapses to show columns
4. ColumnEdge displays transformation labels
5. ImpactPanel shows downstream affected nodes with depth
6. RootCausePanel traces upstream sources
7. Pages navigate correctly and maintain URL state
</verification>

<success_criteria>
- React Flow graph displays column-to-column lineage with table grouping
- elkjs lays out graph left-to-right with proper spacing
- Transformation types (CONCAT, SUM, JOIN, etc.) visible on edges
- Clicking column shows downstream impact in side panel
- Root cause tracing shows upstream path from selected column
- Search finds nodes by name across namespaces
- Deep linking works via URL parameters
- Quality issue can be traced through lineage to source (LIN-04)
</success_criteria>

<output>
After completion, create `.planning/phases/03-column-level-lineage/03-03-SUMMARY.md`
</output>
