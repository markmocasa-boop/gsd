---
phase: 05-self-contained-dependencies
plan: 02
type: execute
depends_on: ["05-01"]
files_modified: [bin/plugin.js]
---

<objective>
Implement service health checks and integrate status reporting into plugin commands.

Purpose: Give users visibility into whether plugin services are running and healthy.
Output: Health check execution and service status in plugin list/info commands.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Prior plan context:**
@.planning/phases/05-self-contained-dependencies/05-01-SUMMARY.md

**Key files:**
@bin/plugin.js
@get-shit-done/references/plugin-format.md

**Tech stack:** Node.js built-ins only (execSync from child_process)
**Established patterns:**
- getServiceConfig() returns services object with docker-compose and healthCheck paths
- isDockerAvailable() returns { available, command }
**Constraining decisions:**
- Health check is optional in manifest (services.healthCheck may be undefined)
- Health check script runs with plugin directory as cwd
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add health check and status functions</name>
  <files>bin/plugin.js</files>
  <action>
Add two functions to plugin.js:

1. `checkServiceHealth(pluginName)` - Run health check script if configured:
   - Call getServiceConfig(pluginName), return { status: 'no-services' } if null
   - If services.healthCheck is not defined, return { status: 'no-healthcheck' }
   - Build health check path: `~/.claude/{pluginName}/{services.healthCheck}`
   - Verify script exists, return { status: 'missing-script', path } if not
   - Execute script with cwd set to plugin directory: `execSync(healthCheckPath, { cwd: pluginDir, stdio: 'pipe' })`
   - Return { status: 'healthy' } on success (exit code 0)
   - Return { status: 'unhealthy', error: stderr } on failure
   - Wrap in try/catch, return { status: 'error', error: message } on exception

2. `getServiceStatus(pluginName)` - Get service running status from Docker:
   - Call getServiceConfig(pluginName), return { running: false, reason: 'no-services' } if null
   - Call isDockerAvailable(), return { running: false, reason: 'no-docker' } if not available
   - Get compose file path from services.docker-compose
   - Run: `{dockerCommand} -f {composePath} ps --format json` (or without --format for older docker-compose)
   - Parse output to determine if services are running
   - Return { running: boolean, containers: number }
   - Handle errors gracefully, return { running: false, reason: 'error', error: message }

Place functions after stopServices().
  </action>
  <verify>node -c bin/plugin.js (syntax check passes)</verify>
  <done>Two functions added: checkServiceHealth(), getServiceStatus()</done>
</task>

<task type="auto">
  <name>Task 2: Add service status to plugin info and list</name>
  <files>bin/plugin.js</files>
  <action>
Modify listPlugins() and showPluginInfo() to show service status:

1. In listPlugins() - after building plugin object:
   - Check if plugin has services (read manifest.gsd?.services)
   - If services exist and plugin is enabled, call getServiceStatus(pluginName)
   - Add status indicator to output line:
     - No services: no indicator
     - Services running: ` ${green}●${reset}` (green dot)
     - Services not running: ` ${yellow}○${reset}` (yellow hollow dot)
     - Docker unavailable: ` ${dim}◌${reset}` (dim dot)

2. In showPluginInfo() - add new "Services" section after "Installation":
   - Only show if manifest.gsd?.services exists
   - Show docker-compose file path
   - Show health check path (if configured)
   - Call getServiceStatus() and show: "Status: Running (N containers)" or "Status: Stopped"
   - If running and healthCheck configured, call checkServiceHealth() and show result
   - Format:
     ```
     Services:
       Docker Compose: docker/docker-compose.yml
       Health Check: docker/health.sh
       Status: Running (2 containers)
       Health: Healthy
     ```

The service status calls should not slow down list/info significantly:
- getServiceStatus uses `docker compose ps` which is fast
- Health check only runs when showing detailed info (not in list)
  </action>
  <verify>
Manual test:
1. `node bin/plugin.js list` - should show status indicators for plugins with services
2. `node bin/plugin.js info my-plugin` - should show Services section if applicable
  </verify>
  <done>
- listPlugins() shows service status indicator (●/○/◌)
- showPluginInfo() shows Services section with status and health
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `node -c bin/plugin.js` passes (no syntax errors)
- [ ] `node bin/plugin.js list` works (even without Docker)
- [ ] `node bin/plugin.js info <plugin>` shows Services section for plugins with services
- [ ] Functions checkServiceHealth, getServiceStatus exist
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Service status visible in plugin list and info
- Graceful degradation when Docker unavailable
</success_criteria>

<output>
After completion, create `.planning/phases/05-self-contained-dependencies/05-02-SUMMARY.md`
</output>
