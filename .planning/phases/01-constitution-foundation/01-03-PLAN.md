---
phase: 01-constitution-foundation
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - ~/.claude/get-shit-done/bin/install.js
  - ~/.claude/get-shit-done/commands/gsd/new-project.md
  - ~/.claude/get-shit-done/src/constitution/init.js
  - bin/install.js
  - commands/gsd/new-project.md
  - src/constitution/init.js
autonomous: true

must_haves:
  truths:
    - "Global CONSTITUTION.md installed to ~/.claude/get-shit-done/ during npm install"
    - "Project CONSTITUTION.md created in .planning/ during /gsd:new-project"
    - "Constitution loader accessible to GSD commands/workflows"
    - "Installation creates constitution from template"
    - "Integration tested in GSD install before repo updated"
  artifacts:
    - path: "~/.claude/get-shit-done/bin/install.js"
      provides: "Installs global CONSTITUTION.md during setup (testing)"
      contains: "CONSTITUTION.md"
      min_lines: 150
    - path: "bin/install.js"
      provides: "Installs global CONSTITUTION.md during setup (repo source)"
      contains: "CONSTITUTION.md"
      min_lines: 150
    - path: "~/.claude/get-shit-done/commands/gsd/new-project.md"
      provides: "Creates project CONSTITUTION.md during init (testing)"
      contains: "CONSTITUTION.md"
    - path: "commands/gsd/new-project.md"
      provides: "Creates project CONSTITUTION.md during init (repo source)"
      contains: "CONSTITUTION.md"
    - path: "~/.claude/get-shit-done/src/constitution/init.js"
      provides: "Constitution initialization helper (testing)"
      exports: ["initGlobalConstitution", "initProjectConstitution"]
      min_lines: 40
    - path: "src/constitution/init.js"
      provides: "Constitution initialization helper (repo source)"
      exports: ["initGlobalConstitution", "initProjectConstitution"]
      min_lines: 40
  key_links:
    - from: "bin/install.js"
      to: "get-shit-done/templates/constitution/global-constitution.md"
      via: "copyWithPathReplacement or similar copy logic"
      pattern: "global-constitution\\.md"
    - from: "commands/gsd/new-project.md"
      to: "get-shit-done/templates/constitution/project-constitution.md"
      via: "Bash copy command or Task creation"
      pattern: "project-constitution\\.md"
    - from: "src/constitution/loader.js"
      to: "System initialization"
      via: "require and instantiate ConstitutionLoader"
      pattern: "ConstitutionLoader"
---

<objective>
Integrate constitution system into GSD installation and project initialization workflows. Test in GSD install location, then update repo source.

Purpose: Wire constitution templates and loader into existing GSD commands so constitutions are automatically created during setup. Two-stage approach allows testing integration in actual GSD environment before committing to source.

Output: Constitution files created during install/init, loader accessible to GSD system, repo source updated.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md

**Two-stage approach:**
1. Modify files in ~/.claude/get-shit-done/ (installed GSD location)
2. Test installation/initialization workflows work correctly
3. Copy working files to repo source (bin/, commands/, src/)
4. Commit repo changes to git
</execution_context>

<context>
@/Users/maciejmoszoro/Projects/GSD-with-constitution/get-shit-done-mm/.planning/PROJECT.md
@/Users/maciejmoszoro/Projects/GSD-with-constitution/get-shit-done-mm/.planning/ROADMAP.md
@/Users/maciejmoszoro/Projects/GSD-with-constitution/get-shit-done-mm/.planning/phases/01-constitution-foundation/01-CONTEXT.md
@/Users/maciejmoszoro/Projects/GSD-with-constitution/get-shit-done-mm/.planning/codebase/STRUCTURE.md
@/Users/maciejmoszoro/Projects/GSD-with-constitution/get-shit-done-mm/.planning/codebase/CONVENTIONS.md

Prior work:
@/Users/maciejmoszoro/Projects/GSD-with-constitution/get-shit-done-mm/.planning/phases/01-constitution-foundation/01-01-SUMMARY.md
@/Users/maciejmoszoro/Projects/GSD-with-constitution/get-shit-done-mm/.planning/phases/01-constitution-foundation/01-02-SUMMARY.md

Existing files to modify:
@/Users/maciejmoszoro/Projects/GSD-with-constitution/get-shit-done-mm/bin/install.js
@/Users/maciejmoszoro/Projects/GSD-with-constitution/get-shit-done-mm/commands/gsd/new-project.md
</context>

<tasks>

<task type="auto">
  <name>Stage 1: Create constitution initialization helper in GSD install</name>
  <files>~/.claude/get-shit-done/src/constitution/init.js</files>
  <action>
Create `~/.claude/get-shit-done/src/constitution/init.js` with helper functions for constitution file creation.

Functions:
1. `initGlobalConstitution(targetDir)` - Copies global template to target directory
2. `initProjectConstitution(targetDir)` - Copies project template to target directory

Implementation:
- Use Node.js fs module (sync methods appropriate for setup operations)
- Read template from `~/.claude/get-shit-done/templates/constitution/*.md`
- Replace placeholder values (lastUpdated with current date)
- Write to target location
- Use path.join for all path operations (cross-platform)
- Return success/failure status

Example:
```javascript
function initGlobalConstitution(targetDir) {
  const templatePath = path.join(__dirname, '..', '..', 'templates', 'constitution', 'global-constitution.md');
  const targetPath = path.join(targetDir, 'CONSTITUTION.md');

  // Read template
  let content = fs.readFileSync(templatePath, 'utf8');

  // Replace placeholders
  const now = new Date().toISOString().split('T')[0];
  content = content.replace(/lastUpdated:.*/, `lastUpdated: ${now}`);

  // Write to target
  fs.writeFileSync(targetPath, content, 'utf8');

  return targetPath;
}
```

Export both functions for use in install.js and new-project workflow.

Create directory if needed: `mkdir -p ~/.claude/get-shit-done/src/constitution`

Follow CONVENTIONS.md: CommonJS modules, camelCase function names, 2-space indent.
  </action>
  <verify>
File exists at `~/.claude/get-shit-done/src/constitution/init.js`.
Exports `initGlobalConstitution` and `initProjectConstitution` functions.
Functions use path.join for all path operations.
Functions replace lastUpdated placeholder with current date.
  </verify>
  <done>
Constitution initialization helpers created in GSD install location.
Functions handle template copying with placeholder replacement.
Ready for integration testing.
  </done>
</task>

<task type="auto">
  <name>Stage 1: Integrate into install script in GSD install</name>
  <files>~/.claude/get-shit-done/bin/install.js</files>
  <action>
Update `~/.claude/get-shit-done/bin/install.js` to install global CONSTITUTION.md during GSD setup.

Add after existing file copy operations (look for where templates/workflows/commands are copied):

1. Require the init helper:
```javascript
const { initGlobalConstitution } = require('../src/constitution/init');
```

2. Create constitution directory in target:
```javascript
const constitutionDir = path.join(homeDir, '.claude', 'get-shit-done');
if (!fs.existsSync(constitutionDir)) {
  fs.mkdirSync(constitutionDir, { recursive: true });
}
```

3. Initialize global constitution:
```javascript
const constitutionPath = initGlobalConstitution(constitutionDir);
console.log(`  ${green}✓${reset} Global constitution: ${constitutionPath}`);
```

Integration point: After existing GSD files are copied, before "Installation complete" message.

Match existing code style: ANSI color codes (green, reset), checkmark symbols, consistent indentation.

DO NOT modify existing installation logic - only add constitution initialization.

First read the current install.js to understand structure:
```bash
cat ~/.claude/get-shit-done/bin/install.js
```
  </action>
  <verify>
`~/.claude/get-shit-done/bin/install.js` imports `initGlobalConstitution`.
Constitution initialization called during install process.
Success message printed with checkmark.
Code follows existing install.js style (ANSI colors, error handling).
Test: Run modified install.js logic (or dry-run) to verify constitution created at expected path.
  </verify>
  <done>
Install script updated in GSD install location.
Global constitution automatically installed during GSD setup.
Integration tested in actual GSD environment.
  </done>
</task>

<task type="auto">
  <name>Stage 1: Integrate into new-project command in GSD install</name>
  <files>~/.claude/get-shit-done/commands/gsd/new-project.md</files>
  <action>
Update `~/.claude/get-shit-done/commands/gsd/new-project.md` to create project CONSTITUTION.md during initialization.

First read current command to understand structure:
```bash
cat ~/.claude/get-shit-done/commands/gsd/new-project.md
```

Find section where .planning/ directory structure is created (after PROJECT.md, ROADMAP.md, STATE.md creation).

Add bash command to copy project constitution template:

```bash
# Create project constitution
cp ~/.claude/get-shit-done/templates/constitution/project-constitution.md .planning/CONSTITUTION.md
sed -i '' "s/lastUpdated:.*/lastUpdated: $(date +%Y-%m-%d)/" .planning/CONSTITUTION.md
echo "✓ Project constitution created"
```

Alternative approach using Node.js (if command uses Task tool for file operations):
Reference `src/constitution/init.js` via Task tool to call `initProjectConstitution(path.join(process.cwd(), '.planning'))`.

Integration point: After `.planning/` directory created, alongside other initialization files.

Match command style: Imperative voice, technical precision, no filler words.

DO NOT modify existing project initialization steps - only add constitution creation.

Test by creating test project directory and running modified command.
  </action>
  <verify>
`~/.claude/get-shit-done/commands/gsd/new-project.md` includes constitution creation step.
Project CONSTITUTION.md created in .planning/ directory.
lastUpdated field populated with current date.
Test: Run new-project command in test directory, verify CONSTITUTION.md created at .planning/CONSTITUTION.md with expected content.
  </verify>
  <done>
New-project command updated in GSD install location.
Project constitution automatically created during project initialization.
Integration tested in actual GSD environment.
  </done>
</task>

<task type="auto">
  <name>Stage 2: Copy working integration files to repo source</name>
  <files>
    bin/install.js
    commands/gsd/new-project.md
    src/constitution/init.js
  </files>
  <action>
After verifying integration works in GSD install location, copy modified files to repo source for git tracking.

Steps:
1. Create repo source directories:
```bash
mkdir -p bin
mkdir -p commands/gsd
mkdir -p src/constitution
```

2. Copy tested files from GSD install to repo:
```bash
cp ~/.claude/get-shit-done/bin/install.js bin/
cp ~/.claude/get-shit-done/commands/gsd/new-project.md commands/gsd/
cp ~/.claude/get-shit-done/src/constitution/init.js src/constitution/
```

3. Verify copies match:
```bash
diff ~/.claude/get-shit-done/bin/install.js bin/install.js
diff ~/.claude/get-shit-done/commands/gsd/new-project.md commands/gsd/new-project.md
diff ~/.claude/get-shit-done/src/constitution/init.js src/constitution/init.js
```

This ensures repo source matches tested GSD install files exactly.

Note: Only copy these specific files - don't overwrite other bin/ or commands/ files unrelated to constitution integration.
  </action>
  <verify>
Files exist at:
- `bin/install.js`
- `commands/gsd/new-project.md`
- `src/constitution/init.js`

Repo files match GSD install files (diff shows no differences).
Files tracked by git in repo source.
Only constitution-related changes present in diffs.
  </verify>
  <done>
Integration files copied from tested GSD install to repo source.
Source files ready for git commit.
Repo source matches working GSD install files.
  </done>
</task>

</tasks>

<verification>
Stage 1 verification (GSD install location):

1. Install verification:
```bash
# Test install script logic (simulated or actual)
# Verify global constitution created
ls ~/.claude/get-shit-done/CONSTITUTION.md
grep "version: 1.0.0" ~/.claude/get-shit-done/CONSTITUTION.md
grep "TDD-01" ~/.claude/get-shit-done/CONSTITUTION.md
```

2. New-project verification:
```bash
# Create test directory and run new-project
mkdir /tmp/test-gsd-project && cd /tmp/test-gsd-project

# Run new-project command (simulated or actual)
# Verify project constitution created
ls .planning/CONSTITUTION.md
grep "version: 1.0.0" .planning/CONSTITUTION.md
```

3. Loader integration verification:
```bash
# Test that loader can access created constitutions
cd /tmp/test-gsd-project
node -e "const {ConstitutionLoader} = require('~/.claude/get-shit-done/src/constitution/loader'); const loader = new ConstitutionLoader(); console.log(loader.load());"
```

Stage 2 verification (repo source):
- Files copied from GSD install to repo source
- Repo files match GSD install files (diff confirms)
- Files tracked in git, ready for commit

End-to-end verification:
- Both constitutions have version 1.0.0 and current lastUpdated date
- Templates include TDD-01 rule (global) and override examples (project)
- ConstitutionLoader accessible and working
- Integration preserves existing install/init workflows
</verification>

<success_criteria>
- [ ] Constitution init helper created in GSD install location
- [ ] Install script updated in GSD install to create global CONSTITUTION.md
- [ ] New-project command updated in GSD install to create project CONSTITUTION.md
- [ ] Both constitutions have version 1.0.0
- [ ] lastUpdated fields populated with current date
- [ ] Integration tested in actual GSD environment
- [ ] End-to-end test confirms files created at expected paths
- [ ] End-to-end test confirms loader can read created constitutions
- [ ] Files copied from GSD install to repo source
- [ ] Repo source files match GSD install files exactly
- [ ] Code committed with message following project conventions
</success_criteria>

<output>
After completion, create `/Users/maciejmoszoro/Projects/GSD-with-constitution/get-shit-done-mm/.planning/phases/01-constitution-foundation/01-03-SUMMARY.md`
</output>
