---
phase: 04-visibility-integration
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - frontend/src/app/(dashboard)/overview/page.tsx
  - frontend/src/app/(dashboard)/layout.tsx
  - frontend/src/components/features/dashboard/health-overview.tsx
  - frontend/src/components/features/dashboard/quality-trend-chart.tsx
  - frontend/src/components/features/dashboard/alert-summary.tsx
  - frontend/src/components/features/dashboard/dataset-health-table.tsx
  - frontend/src/hooks/use-dashboard.ts
  - frontend/src/app/api/v1/datasets/route.ts
  - frontend/src/app/api/v1/quality-scores/route.ts
  - frontend/src/app/api/v1/alerts/route.ts
  - frontend/src/app/api/docs/page.tsx
  - frontend/src/lib/api-spec.ts
  - frontend/package.json
autonomous: true

must_haves:
  truths:
    - "User can view dashboard showing overall data health"
    - "User can see quality scores per dataset"
    - "User can view historical trends of quality metrics"
    - "Developers can access quality data via REST API"
    - "API documentation is accessible at /api/docs"
  artifacts:
    - path: "frontend/src/app/(dashboard)/overview/page.tsx"
      provides: "Dashboard overview page"
      min_lines: 50
    - path: "frontend/src/components/features/dashboard/quality-trend-chart.tsx"
      provides: "Recharts line chart for trends"
      min_lines: 40
    - path: "frontend/src/hooks/use-dashboard.ts"
      provides: "TanStack Query hooks for dashboard data"
      exports: ["useDashboardStats", "useQualityTrends", "useDatasetHealthList"]
    - path: "frontend/src/app/api/v1/quality-scores/route.ts"
      provides: "REST API for quality scores"
      exports: ["GET"]
    - path: "frontend/src/app/api/docs/page.tsx"
      provides: "Swagger UI documentation page"
      min_lines: 20
  key_links:
    - from: "frontend/src/app/(dashboard)/overview/page.tsx"
      to: "frontend/src/hooks/use-dashboard.ts"
      via: "useDashboardStats hook"
      pattern: "useDashboardStats"
    - from: "frontend/src/components/features/dashboard/quality-trend-chart.tsx"
      to: "recharts"
      via: "LineChart component"
      pattern: "LineChart"
    - from: "frontend/src/app/api/v1/quality-scores/route.ts"
      to: "supabase"
      via: "supabase client query"
      pattern: "supabase\\.from.*quality_scores"
---

<objective>
Create dashboard UI and REST API for data health visibility.

Purpose: Enable users to view overall data health across all sources (VIS-02), see quality scores per table (VIS-03), view historical trends (VIS-04), and provide developers REST API access (INT-01).

Output: Dashboard page with health overview cards and trend charts, REST API endpoints with OpenAPI documentation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-visibility-integration/04-RESEARCH.md
@.planning/phases/04-visibility-integration/04-01-SUMMARY.md

# Existing patterns
@frontend/src/app/(dashboard)/layout.tsx
@frontend/src/hooks/use-alerts.ts
@frontend/src/hooks/use-validations.ts
@frontend/src/components/features/profiles/distribution-chart.tsx
@frontend/src/components/features/validations/quality-score-card.tsx
@frontend/src/lib/supabase.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create dashboard hooks and components</name>
  <files>
    frontend/src/hooks/use-dashboard.ts
    frontend/src/components/features/dashboard/health-overview.tsx
    frontend/src/components/features/dashboard/quality-trend-chart.tsx
    frontend/src/components/features/dashboard/alert-summary.tsx
    frontend/src/components/features/dashboard/dataset-health-table.tsx
  </files>
  <action>
Create TanStack Query hooks and React components for dashboard:

**use-dashboard.ts:**
Follow pattern from use-alerts.ts and use-validations.ts:

1. `useDashboardStats()` - Calls supabase.rpc('get_dashboard_stats')
   - Returns: { total_datasets, avg_composite_score, datasets_above_threshold, datasets_below_threshold, open_alerts, critical_alerts }
   - staleTime: 30000 (30s), refetchInterval: 60000 (1 min)

2. `useQualityTrends(datasetId?: string, days?: number)` - Calls supabase.rpc('get_quality_trends', { p_dataset_id, p_days })
   - If no datasetId, fetch first dataset's trends for global view
   - Returns array of { day, dimension, avg_score, rolling_7day_avg }
   - staleTime: 60000 (1 min)

3. `useDatasetHealthList()` - Fetches datasets with their composite scores
   - Query datasets table, then for each call get_composite_quality_score via RPC
   - Returns array of { id, database_name, table_name, composite_score, last_validation_at }
   - Order by composite_score ascending (worst first)
   - staleTime: 30000

**health-overview.tsx:**
Grid of stat cards using shadcn Card component:
- Total Datasets (number)
- Avg Quality Score (percentage with color: green >80%, yellow 60-80%, red <60%)
- Healthy Datasets (datasets_above_threshold count, green badge)
- At Risk Datasets (datasets_below_threshold count, red badge if >0)
- Open Alerts (open_alerts with critical count highlight)

Props: `{ stats: DashboardStats | undefined, isLoading: boolean }`

**quality-trend-chart.tsx:**
Recharts LineChart showing dimension scores over time:
- Import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Legend } from 'recharts'
- X-axis: date (formatted as MMM DD)
- Y-axis: 0-100% (score * 100)
- 5 lines for dimensions with distinct colors:
  - completeness: #22c55e (green)
  - validity: #3b82f6 (blue)
  - uniqueness: #8b5cf6 (purple)
  - consistency: #f59e0b (amber)
  - freshness: #ec4899 (pink)
- Use ResponsiveContainer width="100%" height={300}
- Show Legend below chart
- Tooltip shows formatted percentage

Props: `{ data: TrendDataPoint[], isLoading: boolean, title?: string }`

Transform data from get_quality_trends format (row per dimension per day) to Recharts format (row per day with all dimensions as columns).

**alert-summary.tsx:**
Compact alert summary card:
- Show open alerts count with severity breakdown
- Link to /alerts page
- Use existing useAlertCounts() hook from use-alerts.ts
- Display: "X open (Y critical, Z warning)"

**dataset-health-table.tsx:**
Table showing dataset health scores:
- Columns: Dataset Name, Database, Quality Score, Status, Last Validation, Actions
- Status column: Badge (Healthy/At Risk/Unknown) based on score threshold
- Quality Score: Percentage with color coding
- Actions: Link to /validations?dataset_id=X
- Sort by score ascending (worst first)
- Use shadcn Table component

Props: `{ datasets: DatasetHealth[], isLoading: boolean }`
  </action>
  <verify>
    `cd frontend && npm run build` succeeds without TypeScript errors
  </verify>
  <done>
    Dashboard hooks fetch data from Supabase RPC functions, components render health cards, trend chart, and dataset table
  </done>
</task>

<task type="auto">
  <name>Task 2: Create dashboard page and update navigation</name>
  <files>
    frontend/src/app/(dashboard)/overview/page.tsx
    frontend/src/app/(dashboard)/layout.tsx
  </files>
  <action>
Create dashboard overview page and add to navigation:

**overview/page.tsx:**
'use client' page that composes dashboard components:

```typescript
'use client';

import { useDashboardStats, useQualityTrends, useDatasetHealthList } from '@/hooks/use-dashboard';
import { HealthOverview } from '@/components/features/dashboard/health-overview';
import { QualityTrendChart } from '@/components/features/dashboard/quality-trend-chart';
import { AlertSummary } from '@/components/features/dashboard/alert-summary';
import { DatasetHealthTable } from '@/components/features/dashboard/dataset-health-table';

export default function OverviewPage() {
  const { data: stats, isLoading: statsLoading } = useDashboardStats();
  const { data: trends, isLoading: trendsLoading } = useQualityTrends();
  const { data: datasets, isLoading: datasetsLoading } = useDatasetHealthList();

  return (
    <div className="space-y-6">
      <div>
        <h1 className="text-2xl font-bold">Data Health Overview</h1>
        <p className="text-muted-foreground">Monitor quality across all connected data sources</p>
      </div>

      {/* Stats cards */}
      <HealthOverview stats={stats} isLoading={statsLoading} />

      {/* Two-column layout for chart and alerts */}
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div className="lg:col-span-2">
          <QualityTrendChart data={trends || []} isLoading={trendsLoading} title="Quality Trends (30 days)" />
        </div>
        <div>
          <AlertSummary />
        </div>
      </div>

      {/* Dataset health table */}
      <DatasetHealthTable datasets={datasets || []} isLoading={datasetsLoading} />
    </div>
  );
}
```

**layout.tsx updates:**
Add "Overview" as first item in navigation array:
```typescript
const navigation: NavItem[] = [
  { name: 'Overview', href: '/overview' },  // NEW - add at beginning
  { name: 'Sources', href: '/sources' },
  // ... rest unchanged
];
```
  </action>
  <verify>
    `cd frontend && npm run build` succeeds and page renders without errors
  </verify>
  <done>
    Dashboard page shows health overview, trend chart, alert summary, and dataset health table. Navigation includes Overview link.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create REST API endpoints and Swagger documentation</name>
  <files>
    frontend/src/app/api/v1/datasets/route.ts
    frontend/src/app/api/v1/quality-scores/route.ts
    frontend/src/app/api/v1/alerts/route.ts
    frontend/src/app/api/docs/page.tsx
    frontend/src/lib/api-spec.ts
    frontend/package.json
  </files>
  <action>
Create REST API endpoints with OpenAPI documentation:

**Install dependencies first:**
```bash
cd frontend && npm install next-swagger-doc swagger-ui-react
npm install -D @types/swagger-ui-react
```

**api/v1/datasets/route.ts:**
```typescript
import { NextRequest, NextResponse } from 'next/server';
import { supabase } from '@/lib/supabase';

/**
 * @swagger
 * /api/v1/datasets:
 *   get:
 *     summary: List datasets with quality scores
 *     tags: [Datasets]
 *     parameters:
 *       - in: query
 *         name: limit
 *         schema:
 *           type: integer
 *           default: 50
 *       - in: query
 *         name: offset
 *         schema:
 *           type: integer
 *           default: 0
 *     responses:
 *       200:
 *         description: List of datasets
 */
export async function GET(request: NextRequest) {
  const { searchParams } = new URL(request.url);
  const limit = parseInt(searchParams.get('limit') || '50');
  const offset = parseInt(searchParams.get('offset') || '0');

  const { data, error, count } = await supabase
    .from('datasets')
    .select('*', { count: 'exact' })
    .range(offset, offset + limit - 1)
    .order('created_at', { ascending: false });

  if (error) {
    return NextResponse.json({ error: error.message }, { status: 500 });
  }

  return NextResponse.json({ data, total: count, limit, offset });
}
```

**api/v1/quality-scores/route.ts:**
- GET with optional query params: dataset_id, dimension, start_date, end_date, limit, offset
- JSDoc @swagger annotations for OpenAPI
- Support filtering by dataset_id and dimension
- Date range filtering on measured_at
- Return { data, total, limit, offset }

**api/v1/alerts/route.ts:**
- GET with optional query params: status, severity, alert_type, dataset_id, limit, offset
- JSDoc @swagger annotations
- Filter by status (default: open), severity, alert_type
- Return { data, total, limit, offset }

**lib/api-spec.ts:**
```typescript
import { createSwaggerSpec } from 'next-swagger-doc';

export const getApiDocs = async () => {
  const spec = createSwaggerSpec({
    apiFolder: 'src/app/api/v1',
    definition: {
      openapi: '3.0.0',
      info: {
        title: 'Data Foundations API',
        version: '1.0.0',
        description: 'REST API for data quality metadata and alerts',
      },
      servers: [{ url: '/api/v1', description: 'API v1' }],
      components: {
        schemas: {
          Dataset: {
            type: 'object',
            properties: {
              id: { type: 'string', format: 'uuid' },
              database_name: { type: 'string' },
              table_name: { type: 'string' },
              source_type: { type: 'string', enum: ['s3_iceberg', 'athena', 'redshift'] },
              created_at: { type: 'string', format: 'date-time' },
            },
          },
          QualityScore: {
            type: 'object',
            properties: {
              id: { type: 'string', format: 'uuid' },
              dataset_id: { type: 'string', format: 'uuid' },
              dimension: { type: 'string', enum: ['completeness', 'validity', 'uniqueness', 'consistency', 'freshness'] },
              score: { type: 'number', minimum: 0, maximum: 1 },
              measured_at: { type: 'string', format: 'date-time' },
            },
          },
          Alert: {
            type: 'object',
            properties: {
              id: { type: 'string', format: 'uuid' },
              alert_type: { type: 'string', enum: ['rule_failure', 'freshness_sla', 'volume_anomaly'] },
              severity: { type: 'string', enum: ['critical', 'warning', 'info'] },
              status: { type: 'string', enum: ['open', 'acknowledged', 'resolved', 'snoozed'] },
              title: { type: 'string' },
              message: { type: 'string' },
              created_at: { type: 'string', format: 'date-time' },
            },
          },
        },
      },
    },
  });
  return spec;
};
```

**api/docs/page.tsx:**
```typescript
'use client';

import dynamic from 'next/dynamic';
import 'swagger-ui-react/swagger-ui.css';
import { useEffect, useState } from 'react';

const SwaggerUI = dynamic(() => import('swagger-ui-react'), { ssr: false });

export default function ApiDocsPage() {
  const [spec, setSpec] = useState<object | null>(null);

  useEffect(() => {
    fetch('/api/v1/openapi')
      .then((res) => res.json())
      .then((data) => setSpec(data));
  }, []);

  if (!spec) {
    return <div className="p-8">Loading API documentation...</div>;
  }

  return <SwaggerUI spec={spec} />;
}
```

Also create **api/v1/openapi/route.ts** to serve the spec:
```typescript
import { NextResponse } from 'next/server';
import { getApiDocs } from '@/lib/api-spec';

export async function GET() {
  const spec = await getApiDocs();
  return NextResponse.json(spec);
}
```
  </action>
  <verify>
    `cd frontend && npm run build` succeeds; API routes created at /api/v1/datasets, /api/v1/quality-scores, /api/v1/alerts; docs page at /api/docs
  </verify>
  <done>
    REST API endpoints expose datasets, quality-scores, and alerts with pagination. Swagger UI available at /api/docs with OpenAPI spec.
  </done>
</task>

</tasks>

<verification>
1. Frontend builds: `cd frontend && npm run build`
2. Dashboard page exists at /overview with health cards, trend chart, alert summary, dataset table
3. Navigation includes Overview link as first item
4. API endpoints respond: curl localhost:3000/api/v1/datasets, /api/v1/quality-scores, /api/v1/alerts
5. Swagger docs accessible at /api/docs
</verification>

<success_criteria>
- VIS-02: Dashboard shows overall data health across all sources
- VIS-03: Quality scores displayed per dataset in health table
- VIS-04: Historical trends visible in Recharts line chart
- INT-01: REST API endpoints accessible with OpenAPI documentation
- Navigation updated with Overview as entry point
</success_criteria>

<output>
After completion, create `.planning/phases/04-visibility-integration/04-02-SUMMARY.md`
</output>
