---
phase: 02-plugin-installation
plan: 02
type: execute
depends_on: ["02-01"]
files_modified: [bin/plugin.js]
---

<objective>
Enhance local path installation with proper validation, error handling, and cross-platform compatibility.

Purpose: Support plugin development workflow where developers install plugins from local folders during development.
Output: Robust local installation that handles edge cases, symlinks (optionally), and provides clear feedback.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-plugin-installation/02-01-SUMMARY.md
@get-shit-done/references/plugin-format.md
@bin/plugin.js

**From 02-01:** Basic install command exists, manifest validation works, file copying implemented.

**This plan focuses on:**
- Local path handling edge cases
- Cross-platform path normalization
- Development mode (--link for symlinks vs --copy)
- Better error messages for common issues
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance local path handling and validation</name>
  <files>bin/plugin.js</files>
  <action>
Improve local path installation in bin/plugin.js.

Path handling improvements:
1. Resolve relative paths to absolute: `path.resolve(process.cwd(), inputPath)`
2. Handle ~ expansion: if path starts with ~, replace with os.homedir()
3. Normalize path separators: `path.normalize()` for cross-platform
4. Check path exists and is directory: `fs.statSync(p).isDirectory()`

Enhanced validation before copying:
1. Check plugin.json exists at path
2. Check required directories exist if referenced in manifest:
   - If gsd.commands defined, check commands/ dir exists
   - If gsd.agents defined, check agents/ dir exists
   - etc.
3. Check all referenced files exist (from manifest arrays)

Better error messages:
```
Error: Path does not exist: /path/to/plugin
Error: Not a directory: /path/to/file.txt
Error: Missing plugin.json in /path/to/plugin
Error: Referenced file not found: commands/missing.md
Error: Commands directory missing but commands defined in manifest
```

Add `--verbose` flag to show detailed copy progress:
```
Copying commands/hello.md -> ~/.claude/commands/my-plugin/hello.md
Copying workflows/flow.md -> ~/.claude/my-plugin/workflows/flow.md
```
  </action>
  <verify>Test with various invalid paths (nonexistent, file not dir, missing plugin.json) and verify clear error messages</verify>
  <done>Local path installation handles edge cases gracefully with helpful error messages</done>
</task>

<task type="auto">
  <name>Task 2: Add development mode with --link option</name>
  <files>bin/plugin.js</files>
  <action>
Add --link flag for development workflow that creates symlinks instead of copying.

Implementation:
1. Parse --link flag from args
2. If --link specified:
   - Instead of copying files, create symlinks
   - For directories: `fs.symlinkSync(src, dest, 'junction')` on Windows, `'dir'` elsewhere
   - For individual files: `fs.symlinkSync(src, dest, 'file')`
3. Store "linked: true" in the installed plugin.json for uninstall awareness

Cross-platform symlink handling:
```javascript
function createSymlink(src, dest, type) {
  // Windows needs 'junction' for directories to avoid admin rights
  const linkType = process.platform === 'win32' && type === 'dir' ? 'junction' : type;
  try {
    fs.symlinkSync(src, dest, linkType);
  } catch (err) {
    if (err.code === 'EPERM' && process.platform === 'win32') {
      console.error('Error: Creating symlinks on Windows requires admin rights or Developer Mode');
      console.error('Alternative: Run without --link to copy files instead');
      process.exit(1);
    }
    throw err;
  }
}
```

Benefits of --link for development:
- Edit plugin source, changes reflected immediately
- No need to reinstall after every change
- Clear in plugin.json that it's linked (for uninstall to know)

Output:
```
Installing plugin: my-plugin v1.0.0 (linked)
  ✓ Linked commands/hello.md -> ~/.claude/commands/my-plugin/hello.md
  ✓ Linked 3 files

Plugin is linked. Changes to source will reflect immediately.
```
  </action>
  <verify>Test `node bin/plugin.js install ./test-plugin --link` creates symlinks (verify with `ls -la`)</verify>
  <done>--link flag works, creates symlinks, handles Windows junction types, stores linked status</done>
</task>

<task type="auto">
  <name>Task 3: Handle reinstallation and conflicts</name>
  <files>bin/plugin.js</files>
  <action>
Handle the case where a plugin is already installed.

Conflict detection:
1. Check if ~/.claude/{plugin-name}/ already exists
2. If exists, check if it has plugin.json (is a plugin, not random folder)
3. Compare versions if reinstalling

Options:
- `--force` flag: overwrite existing installation
- Without --force: prompt or error

Implementation:
```javascript
const existingDir = path.join(claudeDir, pluginName);
if (fs.existsSync(existingDir)) {
  const existingManifest = path.join(existingDir, 'plugin.json');
  if (fs.existsSync(existingManifest)) {
    const existing = JSON.parse(fs.readFileSync(existingManifest, 'utf8'));
    if (!args.includes('--force')) {
      console.error(`Plugin ${pluginName} v${existing.version} already installed.`);
      console.error(`Use --force to overwrite or uninstall first.`);
      process.exit(1);
    }
    console.log(`Overwriting existing ${pluginName} v${existing.version}...`);
  }
  // Remove existing before installing
  fs.rmSync(existingDir, { recursive: true, force: true });
}
```

Also handle commands/ namespace conflict:
- Check ~/.claude/commands/{plugin-name}/ exists
- Remove if --force, error otherwise

Output messages:
```
Error: Plugin my-plugin v1.0.0 already installed. Use --force to overwrite.
```
or with --force:
```
Overwriting existing my-plugin v1.0.0...
Installing plugin: my-plugin v1.1.0
```
  </action>
  <verify>Install plugin, try to install again without --force (should error), install with --force (should succeed)</verify>
  <done>Reinstallation is handled gracefully, --force flag works, appropriate warnings shown</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Local path with ~ expands correctly
- [ ] Relative paths resolve correctly
- [ ] --link creates symlinks (or junctions on Windows)
- [ ] --verbose shows detailed progress
- [ ] Reinstall without --force errors appropriately
- [ ] --force overwrites existing installation
</verification>

<success_criteria>
- Local path installation is robust and cross-platform
- Development workflow supported with --link
- Reinstallation conflicts handled with --force option
- Error messages are helpful and actionable
</success_criteria>

<output>
After completion, create `.planning/phases/02-plugin-installation/02-02-SUMMARY.md`:

# Phase 2 Plan 02: Local Path Installation Summary

**[Substantive one-liner]**

## Accomplishments
- [Key outcomes]

## Files Created/Modified
- `bin/plugin.js` - Enhanced with local path handling

## Decisions Made
- [Any decisions]

## Issues Encountered
- [Problems and resolutions]

## Next Phase Readiness
- Ready for 02-03 (uninstall)
</output>
